---
- name: Update and upgrade system, then reboot if required
  hosts: all
  become: yes
  tasks:

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Upgrade all packages
      apt:
        upgrade: dist

    - name: Reboot the system if needed
      reboot:
        reboot_timeout: 600
        test_command: uptime
      when: ansible_facts.packages != {}  # Check if there were any package changes
